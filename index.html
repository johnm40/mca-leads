<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>MCA Lead Finder</title>

<style>
  body { font-family: Arial, sans-serif; background:#0c1321; margin:0; color:white; }
  h1 { text-align:center; color:#f6d776; margin-top:30px; font-size:38px; }

  .search-bar { display:flex; justify-content:center; margin:20px; gap:10px; }
  input, select { padding:14px; font-size:18px; border-radius:8px; border:none; }
  input{ width:420px; }
  button { background:#f6d776; color:#000; border:none; padding:14px 20px; border-radius:8px; font-size:18px; cursor:pointer; font-weight:bold; }

  .container { display:flex; }
  #results { flex:1; padding:20px; }

  .card { background:#111a2b; padding:16px; margin-bottom:12px; border-left:4px solid #f6d776; border-radius:8px; font-size:16px; }
  .line { margin:4px 0; }
  .value { font-weight:bold; }
  .btn-sm { background:#59e460; padding:6px 10px; font-size:14px; border-radius:6px; margin-top:6px; }

  /* CRM panel */
  #crm { width:280px; background:#f6d776; color:#000; padding:14px; height:100vh; overflow-y:auto; }
  #crm h3 { text-align:center; margin-top:0; }
  .crm-card { background:white; border-radius:6px; padding:10px; margin-bottom:10px; font-size:14px; }
  .edit-input { width:95%; padding:6px; margin-top:6px; }

  .link { color:#fff; text-decoration:underline; cursor:pointer; margin-bottom:10px; display:block; text-align:center; }
</style>
</head>
<body>

<h1>Free MCA Lead Finder</h1>

<div class="search-bar">
  <input id="keyword" placeholder="Search industry (contractor, restaurant)">
  <button onclick="findLeads()">Search</button>
</div>

<div class="search-bar" style="margin-top:-10px;">
  <select id="state">
    <option value="">All States</option><option>CA</option><option>FL</option><option>NY</option><option>TX</option><option>VA</option>
  </select>
  <input id="minRev" placeholder="Min Revenue" type="number">
  <input id="maxRev" placeholder="Max Revenue" type="number">
  <input id="filedAfter" type="date">
</div>

<div style="text-align:center; margin-bottom:10px;">
  <button onclick="setSort('desc')">â¬‡ï¸ Revenue High â†’ Low</button>
  <button onclick="setSort('asc')">â¬†ï¸ Revenue Low â†’ High</button>
  <a class="link" href="/filed.html">ğŸ“ Search by Filing Date</a>
</div>

<div class="container">
  <div id="results"></div>

  <div id="crm">
    <h3>ğŸ“‚ Saved Leads</h3>
    <div id="saved"></div>
    <button onclick="downloadCSV()">â¬‡ï¸ Download CSV</button>
  </div>
</div>

<script>
let sortOrder = "desc";
let saved = JSON.parse(localStorage.getItem("savedLeads")||"[]");

function setSort(o){ sortOrder=o; findLeads(); }

async function findLeads(){
  const k = keyword.value, st = state.value, min=minRev.value||0, max=maxRev.value||99999999, fd=filedAfter.value;
  results.innerHTML="ğŸ” Searching...";
  try{
    const r = await fetch(`/api/leads?keyword=${k}&state=${st}&minRev=${min}&maxRev=${max}&filedAfter=${fd}&sortOrder=${sortOrder}`);
    const d = await r.json(); window.last=d;

    results.innerHTML = d.map((b,i)=>`
      <div class="card">
        <div class="line"><span class="value">${b.name}</span></div>
        <div class="line">ğŸ“ ${b.address}</div>
        <div class="line">ğŸ“ ${b.phone||"N/A"}</div>
        <div class="line">ğŸŒ ${b.website||"N/A"}</div>
        <div class="line">ğŸ“§ ${b.email||"N/A"}</div>
        <div class="line">ğŸ‘¤ Owner: ${b.owner||`<button class='btn-sm' onclick='addOwner(${i})'>Add Owner</button>`}</div>
        <div class="line">ğŸ’° Revenue: ${b.revenue?("$"+b.revenue.toLocaleString()):"N/A"}</div>
        <div class="line">ğŸ—“ï¸ Filed: ${b.filedDate||"N/A"}</div>
        <button class="btn-sm" onclick="save(${i})">+ Save</button>
      </div>
    `).join("");
  }catch{
    results.innerHTML="âŒ Error";
  }
}

function addOwner(i){
  const name=prompt("Enter owner name:");
  if(name){
    window.last[i].owner=name;
    save(i);
    findLeads();
  }
}

function save(i){
  saved.push(window.last[i]);
  localStorage.setItem("savedLeads",JSON.stringify(saved));
  loadCRM();
}

function loadCRM(){
  saved = JSON.parse(localStorage.getItem("savedLeads")||"[]");
  savedEl.innerHTML = saved.map((l,i)=>`
    <div class="crm-card">
      <b>${l.name}</b><br>
      ğŸ“ ${l.address}<br>
      ğŸ“ ${l.phone||"N/A"}<br>
      ğŸ‘¤ Owner: ${l.owner||"N/A"}
      <input class="edit-input" placeholder="Edit owner..." 
      onblur="editOwner(${i},this.value)">
      <button style="font-size:12px;color:red" onclick="del(${i})">ğŸ—‘ Delete</button>
    </div>
  `).join("");
}

function editOwner(i,val){
  if(val){
    saved[i].owner=val;
    localStorage.setItem("savedLeads",JSON.stringify(saved));
    loadCRM();
  }
}
function del(i){
  saved.splice(i,1);
  localStorage.setItem("savedLeads",JSON.stringify(saved));
  loadCRM();
}
function downloadCSV(){
  const rows=[["Name","Address","Phone","Email","Owner","Revenue","Filed"],...saved.map(l=>[
    l.name,l.address,l.phone,l.email,l.owner,l.revenue,l.filedDate
  ])];
  const blob=new Blob([rows.map(r=>r.join(",")).join("\n")]);
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="leads.csv"; a.click();
}
loadCRM();
</script>

</body>
</html>
